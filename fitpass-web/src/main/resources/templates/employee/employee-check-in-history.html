<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<th:block th:replace="employee/common/head"></th:block>

<body id="page-top">

<!-- Page Wrapper -->
<div id="wrapper">
    <!-- Sidebar -->
    <th:block th:replace="employee/common/sidebar"></th:block>
    <!-- End of Sidebar -->

    <!-- Content Wrapper -->
    <div id="content-wrapper" class="d-flex flex-column">
        <!-- Main Content -->
        <div id="content">
            <!-- Navbar -->
            <th:block th:replace="employee/common/navbar"></th:block>
            <!-- End of Navbar -->

            <!-- Begin Page Content -->
            <!-- ======= Breadcrumbs ======= -->
            <section class="breadcrumbs">
                <div class="d-flex align-items-center justify-content-lg-between">
                    <ol>
                        <li><a href="#">Fitpass</a></li>
                        <li>Lịch sử check-in</li>
                    </ol>
                </div>
            </section><!-- End Breadcrumbs -->
            <div class="container-fluid">
                <div class="separator-box">
                    <ul class="nav nav-tabs" id="checkInHistoryTabs">
                        <li class="nav-item">
                            <a class="nav-link active" id="flexible-history-tab" data-toggle="tab"
                               href="#flexible">Gói linh hoạt</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="fixed-history-tab" data-toggle="tab" href="#fixed">Gói cố
                                định</a>
                        </li>
                    </ul>
                    <!-- Tab Content -->
                    <div class="tab-content mt-4">
                        <div class="tab-pane fade show active" id="flexible-tab">
                            <div class="search-flexible container pb-4">
                                <div class="row justify-content-center">
                                    <div class="col-sm-4 col-md-8 col-lg-6 col-xl-4 mr-3">
                                        <form class="d-none d-sm-inline-block form-inline mr-auto ml-md-3 my-2 my-md-0 w-100 navbar-search-flexible">
                                            <div class="input-group flexible-search-input">
                                                <input type="hidden" id="departmentId" th:value="${departmentId}">
                                                <input type="text" class="form-control bg-light border-1 small"
                                                       id="searchInputFlexible"
                                                       placeholder="Tìm kiếm..." aria-label="Search"
                                                       aria-describedby="basic-addon2">
                                                <div class="input-group-append">
                                                    <button class="btn btn-primary" type="button"
                                                            id="searchButtonFlexible">
                                                        <i class="fas fa-search fa-sm"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="col-sm-4 col-md-4 col-lg-2 col-xl-2">
                                        <select id="search-by-flexible">
                                            <option value="" disabled selected>Tìm kiếm theo:</option>
                                            <option value="username">Tên người dùng</option>
                                            <option value="phone-number">Số điện thoại</option>
                                        </select>
                                    </div>
                                    <div class="col-sm-4 col-md-4 col-lg-2 col-xl-2">
                                        <select id="filter-date-flexible">
                                            <option value="" disabled selected>Sắp xếp theo:</option>
                                            <option value="day">Trong ngày</option>
                                            <option value="week">Trong tuần</option>
                                            <option value="month">Trong tháng</option>
                                            <option value="year">Trong năm</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <table class="table table-striped rounded">
                                    <thead>
                                    <tr>
                                        <th style="width: 105px;">Ảnh</th>
                                        <th>Tên khách hàng</th>
                                        <th>Số điện thoại</th>
                                        <th>Tên nhân viên</th>
                                        <th>Tên gói</th>
                                        <th>Thời gian Check-in</th>
                                        <th>Thời gian Check-out</th>
                                        <th>Thời gian tập</th>
                                        <th>Giá gói</th>
                                        <th>Credit sử dụng</th>
                                    </tr>
                                    </thead>
                                    <tbody id="listFlexible">
                                    </tbody>
                                </table>
                            </div>
                            <div class="flexible-pagination-container">
                                <ul class="pagination justify-content-center">
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
                                    </li>
                                    <li class="page-item active" aria-current="page">
                                        <a class="page-link" href="#page1">1</a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="#page2">2</a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="#" tabindex="+1">Next</a>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="fixed-tab">
                            <div class="search-fixed container pb-4">
                                <div class="row justify-content-center">
                                    <div class="col-sm-4 col-md-8 col-lg-6 col-xl-4 mr-3">
                                        <form class="d-none d-sm-inline-block form-inline mr-auto ml-md-3 my-2 my-md-0 w-100 navbar-search-fixed">
                                            <div class="input-group fixed-search-input">
                                                <input type="text" class="form-control bg-light border-1 small"
                                                       id="searchInputFixed"
                                                       placeholder="Tìm kiếm..." aria-label="Search"
                                                       aria-describedby="basic-addon2">
                                                <div class="input-group-append">
                                                    <button class="btn btn-primary" type="button"
                                                            id="searchButtonFixed">
                                                        <i class="fas fa-search fa-sm"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="col-sm-4 col-md-4 col-lg-2 col-xl-2">
                                        <select id="search-by-fixed">
                                            <option value="" disabled selected>Tìm kiếm theo:</option>
                                            <option value="username">Tên người dùng</option>
                                            <option value="phone-number">Số điện thoại</option>
                                        </select>
                                    </div>
                                    <div class="col-sm-4 col-md-4 col-lg-2 col-xl-2">
                                        <select id="filter-date-fixed">
                                            <option value="" disabled selected>Sắp xếp theo:</option>
                                            <option value="day">Trong ngày</option>
                                            <option value="week">Trong tuần</option>
                                            <option value="month">Trong tháng</option>
                                            <option value="year">Trong năm</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <table class="table table-striped rounded">
                                    <thead>
                                    <tr>
                                        <th style="width: 105px;">Ảnh</th>
                                        <th>Tên khách hàng</th>
                                        <th>Số điện thoại</th>
                                        <th>Tên nhân viên</th>
                                        <th>Tên gói</th>
                                        <th>Thời gian Check-in</th>
                                        <th>Giá gói</th>
                                    </tr>
                                    </thead>
                                    <tbody id="listFixed">
                                    </tbody>
                                </table>
                            </div>
                            <div class="fixed-pagination-container">
                                <ul class="pagination justify-content-center">
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
                                    </li>
                                    <li class="page-item active" aria-current="page">
                                        <a class="page-link" href="#page1">1</a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="#page2">2</a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="#" tabindex="+1">Next</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Modal -->
                <div id="imageModal" class="modal">
                    <div class="modal-content">
                        <span class="close" id="closeModal">&times;</span>
                        <img class="modal-image" id="modalImage" src="" alt="Ảnh người dùng">
                    </div>
                </div>
            </div>
            <!-- /.container-fluid -->
        </div>
        <!-- End of Main Content -->
        <!-- Footer -->
        <th:block th:replace="employee/common/footer :: footer"></th:block>
        <!-- End of Footer -->
    </div>
    <!-- End of Content Wrapper -->

</div>
<!-- End of Page Wrapper -->

<!-- Scroll to Top Button-->
<a class="scroll-to-top rounded" href="#page-top">
    <i class="fas fa-angle-up"></i>
</a>

<!-- Logout Modal-->
<th:block th:replace="employee/common/logout-modal"></th:block>

<!-- Script -->
<th:block th:replace="employee/common/script :: script"></th:block>
<script>
    let globalCurrentPage = 1;
    let defaultPageSize = 7;
    let gymPlanType = "flexible";
    const departmentId = $('#departmentId').val();
    $(document).ready(function () {
        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            let targetId = $(e.target).attr("href");
            let gymPlanType = targetId === "#flexible" ? "flexible" : "fixed";

            console.log("shown.bs.tab event triggered - targetId: " + targetId + ", gymPlanType: " + gymPlanType);

            // Add 'show' and 'active' classes to the shown tab content
            $(targetId + '-tab').addClass('show active');

            // If the other tab was previously active, remove 'show' and 'active' from it
            let otherTabId = gymPlanType === "flexible" ? "#fixed-tab" : "#flexible-tab";
            $(otherTabId).removeClass('show active');

            try {
                const params = new URLSearchParams();
                params.set("id", departmentId);
                params.set("plan", gymPlanType);
                params.set("page", globalCurrentPage);
                params.set("size", defaultPageSize);

                fetch(`/employee/history/getListHistory?${params}`)
                    .then(response => response.json())
                    .then(data => {
                        renderPagination(data.currentPage, data.totalPages, gymPlanType);
                        loadTable(data.currentPage, defaultPageSize, gymPlanType);
                    });
            } catch (error) {
                console.error('Error:', error);
            }
        });
        // Manually show the #flexible-tab
        $('a[href="#flexible"]').trigger('shown.bs.tab');
    });

    function renderPagination(currentPage, totalPages, gymPlanType) {
        const paginationContainer = $(`.${gymPlanType}-pagination-container ul`);
        paginationContainer.empty();

        // Generate the previous button
        const previousLink = $('<a>').addClass('page-link').attr('href', '#').text('Trước');
        const previousLi = $('<li>').addClass('page-item').append(previousLink);
        paginationContainer.append(previousLi);

        // Generate the pagination links dynamically
        for (let page = 1; page <= totalPages; page++) {
            const link = $('<a>').addClass('page-link').attr('href', `#page${page}`).text(page);
            const li = $('<li>').addClass('page-item').append(link);
            if (page === currentPage) {
                li.addClass('active'); // Add the "active" class to the current page item
            }
            link.on('click', function (event) {
                event.preventDefault();
                currentPage = page; // Update the currentPage
                renderPagination(currentPage, totalPages, gymPlanType);
                paginationClick(page); // Call your paginationClick function with the current page
                loadTable(currentPage, defaultPageSize, gymPlanType); // Load the table for the current page
            });
            paginationContainer.append(li);
        }

        // Generate the next button
        const nextLink = $('<a>').addClass('page-link').attr('href', '#').text('Sau');
        const nextLi = $('<li>').addClass('page-item').append(nextLink);
        paginationContainer.append(nextLi);

        // Event handler for the previous button
        previousLink.on('click', function (event) {
            event.preventDefault();
            if (currentPage > 1) {
                currentPage--;
                renderPagination(currentPage, totalPages, gymPlanType);
                paginationClick(currentPage);
                loadTable(currentPage, defaultPageSize, gymPlanType);
            }
        });

        // Event handler for the next button
        nextLink.on('click', function (event) {
            event.preventDefault();
            if (currentPage < totalPages) {
                currentPage++;
                renderPagination(currentPage, totalPages, gymPlanType);
                paginationClick(currentPage);
                loadTable(currentPage, defaultPageSize, gymPlanType);
            }
        });
    }

    function paginationClick(page) {
        loadTable(page, defaultPageSize, gymPlanType)
    }

    function loadTable(page, size, gymPlanType) {
        console.log("loading table")
        console.log(gymPlanType)
        const loadParams = new URLSearchParams()
        loadParams.set("id", departmentId)
        loadParams.set("plan", gymPlanType)
        loadParams.set("page", page)
        loadParams.set("size", size)

        fetch(`/employee/history/getListHistory?${loadParams}`)
            .then(data => {
                if (!data.ok) {
                    throw new Error(`HTTP error! Status: ${data.status}`);
                }
                return data.json()
            })
            .then(data => {
                let tableContent;
                if (gymPlanType === 'flexible') {
                    tableContent = $('#listFlexible');
                    tableContent.empty(); // Clear the existing table content

                    $.each(data.listFlexible, function (index, rowData) {
                        let rowHtml = `
                    <tr>
                        <td><button class="view-image-btn view-detail" data-image-src="${rowData.userImageUrl}">Xem ảnh</button></td>
                        <td>${rowData.username}</td>
                        <td>${rowData.phoneNumber}</td>
                        <td>${rowData.empName}</td>
                        <td>${rowData.gymPlanName}</td>
                        <td>${new Date(rowData.checkInTime).toLocaleString()}</td>
                        <td>${rowData.checkOutTime !== null ? new Date(rowData.checkOutTime).toLocaleString() : 'Chưa check out'}</td>
                        <td>${rowData.duration}</td>
                        <td><h5 class="text-money"><span>${rowData.pricePerHours}</span> <span class="credit">Credit/Giờ</span></h5></td>
                        <td><h5 class="text-money"><span>${rowData.totalCredit !== null ? rowData.totalCredit : '0'}</span> <span class="credit">Credit</span></h5></td>
                    </tr>
                    `;
                        tableContent.append(rowHtml);
                    });
                } else if (gymPlanType === 'fixed') {
                    tableContent = $('#listFixed');
                    tableContent.empty(); // Clear the existing table content

                    $.each(data.listFixed, function (index, rowData) {
                        let rowHtml = `
                    <tr>
                        <td><button class="view-image-btn view-detail" data-image-src="${rowData.userImageUrl}">Xem ảnh</button></td>
                        <td>${rowData.username}</td>
                        <td>${rowData.phoneNumber}</td>
                        <td>${rowData.empName}</td>
                        <td>${rowData.gymPlanName}</td>
                        <td>${new Date(rowData.checkInTime).toLocaleString()}</td>
                        <td><h5 class="text-money"><span>${rowData.credit}</span> <span class="credit">Credit</span></h5></td>
                    </tr>
                    `;
                        tableContent.append(rowHtml);
                    });
                }
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });
    }

    ///////////////////////////////////////////////Search Function//////////////////////////////////////////////////
    $(".navbar-search-flexible").submit(function(event) {
        event.preventDefault();
        $("#searchButtonFlexible").click();
    });

    $(".navbar-search-fixed").submit(function(event) {
        event.preventDefault();
        $("#searchButtonFixed").click();
    });

    $("#searchButtonFlexible").click(function (event) {
        event.preventDefault();
        let searchText = $("#searchInputFlexible").val().trim(); // Use trim() to remove whitespace
        let searchOption = $("#search-by-flexible").val();
        let filterDate = $("#filter-date-flexible").val();
        let departmentId = $("#departmentId").val();

        // Remove any existing error messages
        $('.error-message').remove();

        // Initialize a flag to check if the input is valid
        let isValidInput = true;

        // Check if a search option has been chosen
        if (!searchOption) {
            // Display an error message for search option
            $("<div class='error-message' style='color: red;'>Hãy chọn 1 cách tìm kiếm</div>").insertAfter("#search-by-flexible");
            // Optionally add a red outline to the select dropdown
            $("#search-by-flexible").css('border', '1px solid red');
            isValidInput = false;
        } else {
            // If a search option is selected, remove the red outline
            $("#search-by-flexible").css('border', '');
        }

        if (!searchText) {
            // Display an error message for search text
            $("<div class='error-message' style='color: red; display: block; width: 100%; margin-top: 0.25rem;'>Hãy nhập nội dung tìm kiếm</div>").insertAfter(".input-group flexible-search-input");
            // Optionally add a red outline to the input field
            $("#searchInputFlexible").css('border', '1px solid red');
            isValidInput = false;
        } else {
            // If search text is not empty, remove the red outline
            $("#searchInputFlexible").css('border', '');
        }

        // Proceed with the search if the input is valid
        if (isValidInput) {
            $('#listFlexible').empty();
            searchListFlex(searchText, searchOption, filterDate, departmentId);
        }
    });

    $("#searchButtonFixed").click(function (event){
        event.preventDefault();

        let searchText = $("#searchInputFixed").val().trim();
        let searchOption = $("#search-by-fixed").val();
        let filterDate = $("#filter-date-fixed").val();
        let departmentId = $("#departmentId").val();
        // Remove any existing error messages
        $('.error-message').remove();

        // Initialize a flag to check if the input is valid
        let isValidInput = true;

        // Check if a search option has been chosen
        if (!searchOption) {
            // Display an error message for search option
            $("<div class='error-message' style='color: red;'>Hãy chọn 1 cách tìm kiếm </div>").insertAfter("#search-by-fixed");
            // Optionally add a red outline to the select dropdown
            $("#search-by-fixed").css('border', '1px solid red');
            isValidInput = false;
        } else {
            // If a search option is selected, remove the red outline
            $("#search-by-fixed").css('border', '');
        }

        if (!searchText) {
            // Display an error message for search text
            $("<div class='error-message' style='color: red; display: block; width: 100%; margin-top: 0.25rem;'>Hãy nhập nội dung tìm kiếm</div>").insertAfter(".input-group fixed-search-input");
            // Optionally add a red outline to the input field
            $("#searchInputFixed").css('border', '1px solid red');
            isValidInput = false;
        } else {
            // If search text is not empty, remove the red outline
            $("#searchInputFixed").css('border', '');
        }

        // Proceed with the search if the input is valid
        if (isValidInput) {
            $('#listFixed').empty();
            searchListFixed(searchText, searchOption, filterDate, departmentId);
        }
    });

    function searchListFlex(searchText, searchOption, filterDate, departmentId) {
        console.log("enable search")
        let data = {
            id: departmentId === "" ? null : departmentId
        };
        if (searchOption === "username") {
            data.username = searchText;
        } else if (searchOption === "phone-number") {
            data.id = departmentId;
            data.phoneNumber = searchText;
        }
        if (filterDate) {
            data.dateFilter = filterDate;
        }

        console.log(data)
        // Perform the AJAX request
        $.ajax({
            url: "/employee/history/searchFlex",
            data: data,
            type: "GET",
            success: function(response) {
                updateTableAndPaginationFlexible(response, searchText, searchOption, filterDate, departmentId);
            },
            error: function(xhr, status, error) {
                console.error("Error occurred during AJAX request:", status, error);
            }
        });
    }

    function updateTableAndPaginationFlexible(response, searchText, searchOption, filterDate, departmentId) {
        let tableContent = $('#listFlexible');
        tableContent.empty(); // Clear the existing table content

        // Populate the table content with the response data
        if (response.listFlexible.length === 0) {
            tableContent.append(`<tr><td colspan="10" class="text-center">Không có dữ liệu</td></tr>`);
        } else {
            $.each(response.listFlexible, function (index, rowData) {
                let rowHtml = `
                <tr>
                    <td><button class="view-image-btn view-detail" data-image-src="${rowData.userImageUrl}">Xem ảnh</button></td>
                    <td>${rowData.username}</td>
                    <td>${rowData.phoneNumber}</td>
                    <td>${rowData.empName}</td>
                    <td>${rowData.gymPlanName}</td>
                    <td>${new Date(rowData.checkInTime).toLocaleString()}</td>
                    <td>${rowData.checkOutTime !== null ? new Date(rowData.checkOutTime).toLocaleString() : 'Chưa check out'}</td>
                    <td>${rowData.duration}</td>
                    <td><h5 class="text-money"><span>${rowData.pricePerHours}</span> <span class="credit">Credit/Giờ</span></h5></td>
                    <td><h5 class="text-money"><span>${rowData.totalCredit !== null ? rowData.totalCredit : '0'}</span> <span class="credit">Credit</span></h5></td>
                </tr>
            `;
                tableContent.append(rowHtml);
            });
        }

        // Update the pagination controls
        let paginationContent = $('.pagination');
        paginationContent.empty(); // Clear existing pagination controls

        // 'Previous' button
        let prevClass = response.currentPage === 1 ? 'page-item disabled' : 'page-item';
        paginationContent.append(`
        <li class="${prevClass}">
            <a class="page-link" href="#" onclick="searchListFlex('${searchText}', '${searchOption}', '${filterDate}', '${departmentId}', ${response.currentPage - 1}); return false;">Previous</a>
        </li>
    `);

        // Page numbers
        for (let i = 1; i <= response.totalPages; i++) {
            let pageClass = response.currentPage === i ? 'page-item active' : 'page-item';
            paginationContent.append(`
            <li class="${pageClass}">
                <a class="page-link" href="#" onclick="searchListFlex('${searchText}', '${searchOption}', '${filterDate}', '${departmentId}', ${i}); return false;">${i}</a>
            </li>
        `);
        }

        // 'Next' button
        let nextClass = response.currentPage >= response.totalPages ? 'page-item disabled' : 'page-item';
        paginationContent.append(`
        <li class="${nextClass}">
            <a class="page-link" href="#" onclick="searchListFlex('${searchText}', '${searchOption}', '${filterDate}', '${departmentId}', ${response.currentPage + 1}); return false;">Next</a>
        </li>
    `);
    }

    function searchListFixed(searchText, searchOption, filterDate, departmentId) {
        let data = {
            id: departmentId
        };
        if (searchOption === "username") {
            data.username = searchText;
        } else if (searchOption === "phone-number") {
            data.phoneNumber = searchText;
        }
        if (filterDate) {
            data.dateFilter = filterDate;
        }

        // Perform the AJAX request
        $.ajax({
            url: "/employee/history/searchFixed",
            data: data,
            type: "GET",
            success: function (response) {
                // Pass the response data to update both table and pagination
                updateTableAndPaginationFixed(response);
            },
            error: function (xhr, status, error) {
                console.error("Error occurred during AJAX request:", status, error);
            }
        });
    }

    function updateTableAndPaginationFixed(response) {
        let tableContent = $('#listFixed');
        tableContent.empty(); // Clear the existing table content

        // Update table with new data
        if (response.listFixed.length === 0) {
            tableContent.append(`<tr><td colspan="7" class="text-center">Không có dữ liệu</td></tr>`);
        } else {
            $.each(response.listFixed, function (index, rowData) {
                let rowHtml = `
                <tr>
                    <td><button class="view-image-btn view-detail" data-image-src="${rowData.userImageUrl}">Xem ảnh</button></td>
                    <td>${rowData.username}</td>
                    <td>${rowData.phoneNumber}</td>
                    <td>${rowData.empName}</td>
                    <td>${rowData.gymPlanName}</td>
                    <td>${new Date(rowData.checkInTime).toLocaleString()}</td>
                    <td><h5 class="text-money"><span>${rowData.credit}</span> <span class="credit">Credit</span></h5></td>
                </tr>
            `;
                tableContent.append(rowHtml);
            });
        }

        // Update pagination
        let paginationContainer = $('.fixed-pagination-container ul.pagination');
        paginationContainer.empty(); // Clear the existing pagination content

        // Add 'Previous' button
        let prevClass = response.currentPage === 1 ? 'page-item disabled' : 'page-item';
        let prevPage = response.currentPage > 1 ? response.currentPage - 1 : 1;
        paginationContainer.append(`
        <li class="${prevClass}">
            <a class="page-link" href="#" data-page="${prevPage}">Previous</a>
        </li>
    `);

        // Add page numbers
        for (let i = 1; i <= response.totalPages; i++) {
            let pageClass = i === response.currentPage ? 'page-item active' : 'page-item';
            paginationContainer.append(`
            <li class="${pageClass}" aria-current="page">
                <a class="page-link" href="#" data-page="${i}">${i}</a>
            </li>
        `);
        }

        // Add 'Next' button
        let nextClass = response.currentPage === response.totalPages ? 'page-item disabled' : 'page-item';
        let nextPage = response.currentPage < response.totalPages ? response.currentPage + 1 : response.totalPages;
        paginationContainer.append(`
        <li class="${nextClass}">
            <a class="page-link" href="#" data-page="${nextPage}">Next</a>
        </li>
    `);

        // Attach click event to pagination links
        paginationContainer.find('a.page-link').on('click', function (event) {
            event.preventDefault();
            let page = $(this).data('page');
            if (page && !$(this).parent().hasClass('disabled')) {
                // Call the search function with the new page number
                // You may need to adjust this to pass the correct parameters
                searchListFixed($('#searchInputFixed').val(), $('#search-by-fixed').val(), $('#filter-date-fixed').val(), $('#departmentId').val(), page);
            }
        });
    }
</script>
</body>
</html>
