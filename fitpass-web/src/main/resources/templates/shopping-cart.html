<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giỏ Hàng</title>
    <meta name="description" content="">
    <meta name="keywords" content="">
    <link rel="icon" th:href="@{/assets/img/icon.png}">
    <link rel="apple-touch-icon" th:href="@{assets/img/apple-touch-icon.png}">
    <script src="https://kit.fontawesome.com/a59b9b09ab.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" th:href="@{/https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css}">
    <link
            href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Raleway:300,300i,400,400i,500,500i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i"
            rel="stylesheet">
    <link th:href="@{/user-homepage-assets/assets/vendor/aos/aos.css}" rel="stylesheet">
    <link th:href="@{/user-homepage-assets/assets/vendor/bootstrap/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/user-homepage-assets/assets/vendor/bootstrap-icons/bootstrap-icons.css}" rel="stylesheet">
    <link th:href="@{/user-homepage-assets/assets/vendor/boxicons/css/boxicons.min.css}" rel="stylesheet">
    <link th:href="@{/user-homepage-assets/assets/vendor/glightbox/css/glightbox.min.css}" rel="stylesheet">
    <link th:href="@{/user-homepage-assets/assets/vendor/remixicon/remixicon.css}" rel="stylesheet">
    <link th:href="@{/user-homepage-assets/assets/vendor/swiper/swiper-bundle.min.css}" rel="stylesheet">
    <link rel="stylesheet" th:href="@{https://www.w3schools.com/w3css/4/w3.css}">
    <link th:href="@{/user-homepage-assets/assets/css/MyStyle.css}" rel="stylesheet">
</head>

<body class="body-my-card">
<!-- ======= Header ======= -->
<header th:replace="common/navbar :: navbar"></header>

<!-- Content -->
<div id="my-card" class="my-card-container container">
    <h2 class="row">Giỏ hàng của bạn</h2>
    <div class="line row"></div>
    <div class="my-card-title row">
        <div class="form-check">
            <input class="auto" onchange="checkAll(this)" id="check-all" type="checkbox" value="" />
            <label class="" for="flexCheckChecked"> </label>
        </div>
        <div class="my-plan-title">Gói tập</div>
        <div class="price-title">Đơn giá (credits)</div>
        <div class="num-of-plan-title">Số lượng</div>
        <div class="action-title">Thao tác</div>
    </div>
    <!-- Để foreach ở đây -->
    <div th:each="department : ${departmentList}">
        <div class="plan-in-my-card">
            <div class="all-plan-of-gym row">
                <div class="form-check">
                    <input onchange='checkAllGym(this)' name="gym" class="dept-checkbox" type="checkbox" value="" id="flexCheckChecked" />
                    <label class="" for="flexCheckChecked"> </label>
                </div>
                <div class="gym-name-mc" th:text="${department.getDepartmentName()}">Phòng gym hòa lạc</div>
            </div>
            <th:block th:each="cartItem: ${cartItems}">
                <th:block th:if="${cartItem.getGymPlan().getGymDepartmentId() == department.getDepartmentId()}">
                    <!-- Từng gym plan -->
                    <div class="row" style="height: 15px; background-color: white;"></div>
                    <div class="gym-department-plan row">
                        <div class="form-check">
                            <input onclick='updateCartTotal(this)' name="plan" class="plan-checkbox" type="checkbox" value="" th:attr="data-product-id=${cartItem.getGymPlan().getGymPlanId()}, data-dept-id=${department.getDepartmentId()}" />
                            <label class="" for="flexCheckChecked"> </label>
                        </div>
                        <div class="plan-card-mc">
                            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT0ZzXyHZsB8zbJbdSjPVnhudXgXWnDbJIdOQ&usqp=CAU" />
                            <div class="plan-info-mc">
                                <h4 th:text="${cartItem.getGymPlan().getGymPlanName()}"></h4>
                                <div th:text=" 'Thời lượng ' +  ${cartItem.getGymPlan().getDuration()} + ' ngày'">Thời lượng 365 ngày</div>
                            </div>
                            <div class="active-time-mc" th:text=" 'Kích hoạt trong vòng ' +  ${cartItem.getGymPlan().getPlanAfterActiveValidity()} + ' ngày'">
                                Kích hoạt trong vòng 10 ngày
                            </div>
                        </div>
                        <div class="plan-price-mc" th:text="${cartItem.getGymPlan().getPrice()}">
                            200
                        </div>
                        <div class="num-of-plan-mc" >
                            <div class="product-quantity" th:text="${cartItem.getQuantity()}">1</div>
                        </div>

                        <button type="button" class="btn btn-warning" th:onclick="'removeFromCart(' + ${cartItem.getGymPlan().getGymPlanId()} + ')'">
                            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-trash-fill" viewBox="0 0 16 16">
                                <path
                                        d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1H2.5zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zM8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5zm3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0z"
                                />
                            </svg>
                        </button>
                    </div>
                </th:block>
            </th:block>
        </div>
    </div>

    <div class="row" style="height: 15px; background-color: white;"></div>
    <div class="total-container-mc row justify-content-center">
        <h3 class="total-plan-mc col-md-4 col-sm-3 col-3">
            <span id="count-all-plan-mc">0</span>
            <span>sản phẩm</span>
        </h3>
        <div class="total-credits-mc col-md-6 col-sm-5 col-6">
            <span class="total-title">Tổng thanh toán : </span>
            <span id="total-price-mc" class="total">0</span>
        </div>
        <div class="buy-button-mc col-md-2 col-sm-4 col-3">
            <button disabled type="button" onclick="checkout()" class="btn btn-warning" style="font-weight: 700;">Mua hàng</button>
        </div>
    </div>
</div>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Vendor JS Files -->
<script th:src="@{/user-homepage-assets/assets/vendor/purecounter/purecounter_vanilla.js}"></script>
<script th:src="@{/user-homepage-assets/assets/vendor/aos/aos.js}"></script>
<script th:src="@{/user-homepage-assets/assets/vendor/bootstrap/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/user-homepage-assets/assets/vendor/glightbox/js/glightbox.min.js}"></script>
<script th:src="@{/user-homepage-assets/assets/vendor/isotope-layout/isotope.pkgd.min.js}"></script>
<script th:src="@{/user-homepage-assets/assets/vendor/swiper/swiper-bundle.min.js}"></script>
<script th:src="@{/user-homepage-assets/assets/vendor/php-email-form/validate.js}"></script>

<!-- Template Main JS File -->
<script th:src="@{/user-homepage-assets/assets/js/main.js}"></script>
<script>

    var count = 0;
    let selectedItems = [];
    // check all
    let checkboxs = document.getElementById("my-card").querySelectorAll("input[type='checkbox']")
    let dept_checkboxes = document.querySelectorAll('.dept-checkbox');
    let cbActual = document.getElementById("my-card").querySelectorAll('input:not([class=auto])');
    let numOfPlan = document.getElementById("my-card").getElementsByClassName("plan-checkbox");

    cbActual.forEach(cb => {
        cb.addEventListener('change', (event) =>{
            if(!event.target.checked){
                document.getElementById('check-all').checked = false;
                count -= 1;
            } else{
                count += 1;
                if(count == numOfPlan.length+1){
                    document.getElementById('check-all').checked = true;
                }
                if([...cbActual].every(cb=>cb.checked == true))
                    document.getElementById('check-all').checked = true;
            }
            // console.log(count);
            if(selectedItems.length > 0) {
                document.querySelector('.buy-button-mc button').disabled = false;
            } else {
                document.querySelector('.buy-button-mc button').disabled = true;
            }
        })
    })
    function checkAll(myCheckAll){
        // count = 0;
        if(myCheckAll.checked === true){
            count = numOfPlan.length;
            checkboxs.forEach(function(checkbox){
                checkbox.checked = true;
            });
        } else {
            count = 0;
            checkboxs.forEach(function(checkbox){
                checkbox.checked = false;
            });
        }
    }

    // check all in each gym department
    for(var i=0; i<dept_checkboxes.length; i++){
        let cbActual1 = dept_checkboxes[i].parentElement.parentElement.parentElement.querySelectorAll('input:not([class=dept-checkbox])');
        console.log(cbActual1);
        cbActual1.forEach(cb1 => {
            cb1.addEventListener('change', (event) =>{
                if(!event.target.checked){
                    // count -= 1;
                    let test = cb1.parentElement.parentElement.parentElement.getElementsByClassName("dept-checkbox");
                    cb1.parentElement.parentElement.parentElement.getElementsByClassName("dept-checkbox")[0].checked = false;
                } else{
                    if([...cbActual1].every(cb1=>cb1.checked == true)){
                        cb1.parentElement.parentElement.parentElement.getElementsByClassName("dept-checkbox")[0].checked = true;
                    }
                }
                console.log(count);
                console.log(JSON.stringify(selectedItems));
            })
        })
    }
    function checkAllGym(myCheckAll){
        let own_checkboxs = myCheckAll.parentElement.parentElement.parentElement.querySelectorAll("input[type='checkbox']");
        if(myCheckAll.checked === true){
            document.querySelector('.buy-button-mc button').disabled = false;
            own_checkboxs.forEach(function(checkbox){
                checkbox.checked = true;
                addToUniqueArray(selectedItems, checkbox.getAttribute("data-product-id", "data-dept-id"));
            });
        } else {
            let valuesToRemove = [];
            own_checkboxs.forEach(function(checkbox){
                checkbox.checked = false;
                addToUniqueArray(valuesToRemove, checkbox.getAttribute("data-product-id"));
                selectedItems = selectedItems.filter(item =>  !valuesToRemove.includes(item));
                console.log(JSON.stringify(selectedItems));
            });
            // if(selectedItems.length > 0) {
            //     document.querySelector('.buy-button-mc button').disabled = false;
            // } else {
            //     document.querySelector('.buy-button-mc button').disabled = true;
            // }
        }
        console.log(JSON.stringify(selectedItems));
        console.log(selectedItems.length);
    }


    function updateCartTotal(checkBox){
        let total = document.getElementById("total-price-mc").innerHTML;
        total_int = parseInt(total);
        get2 = checkBox.parentElement.parentElement.getElementsByClassName("plan-price-mc");
        price_int = parseInt(get2[0].innerHTML);
        let quantity = checkBox.parentElement.parentElement.querySelector(".product-quantity");
        if(checkBox.checked){
            total_int = total_int + price_int * quantity.innerHTML;
            document.getElementById("total-price-mc").innerHTML = total_int;
            console.log(total_int);
            addToUniqueArray(selectedItems, checkBox.getAttribute("data-product-id"));
        }
        else{
            total_int = total_int - price_int * quantity.innerHTML;
            document.getElementById("total-price-mc").innerHTML = total_int;
            console.log(total_int);
            selectedItems = selectedItems.filter(item => item !== checkBox.getAttribute("data-product-id"));
        }


        if(selectedItems.length > 0) {
            document.querySelector('.buy-button-mc button').disabled = false;
        } else {
            document.querySelector('.buy-button-mc button').disabled = true;
        }
    }

    function checkout() {
        const url = `/checkout/view?idList=${selectedItems.join(',')}`;
        window.location.href = url;
    }

    function addToUniqueArray(arr, element) {
        if (arr.indexOf(element) === -1 && element!== null) {
            arr.push(element);
        }
    }


    function removeFromCart(gymPlanId) {
        Swal.fire({
            title: 'Bạn có chắc chắn muốn xóa sản phẩm khỏi giỏ hàng?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Xóa',
            cancelButtonText: 'Hủy',
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = '/cart/remove?gymPlanId=' + gymPlanId;
            }
        });
    }

    var increaseButtons = document.querySelectorAll(".increase-button");
    var decreaseButtons = document.querySelectorAll(".decrease-button");

    increaseButtons.forEach(function(button) {
        button.addEventListener("click", function() {
            var productId = button.getAttribute("data-product-id");
            increaseQuantity(productId);
        });
    });

    decreaseButtons.forEach(function(button) {
        button.addEventListener("click", function() {
            var productId = button.getAttribute("data-product-id");
            decreaseQuantity(productId);
        });
    });

    function increaseQuantity(productId) {
        // Sử dụng productId để xác định sản phẩm cần tăng
        var newQuantity = parseInt(document.querySelector(".product-quantity[data-product-id='" + productId + "']").textContent) + 1;
        updateQuantity(productId, newQuantity);
    }

    function decreaseQuantity(productId) {
        // Sử dụng productId để xác định sản phẩm cần giảm
        var currentQuantity = parseInt(document.querySelector(".product-quantity[data-product-id='" + productId + "']").textContent);
        if (currentQuantity > 1) {
            var newQuantity = currentQuantity - 1;
            updateQuantity(productId, newQuantity);
        }
    }

    function updateQuantity(productId, newQuantity) {
        console.log(JSON.stringify({
            gymPlanId: +productId,
            quantity: newQuantity,
        }))
        fetch("/cart/update", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                gymPlanId: +productId,
                quantity: newQuantity,
            }),
        })
            .then((response) => console.log(response))
            .then((data) => {
                // Xử lý phản hồi từ máy chủ (nếu cần)
                // Cập nhật số lượng sản phẩm trong giao diện người dùng
                document.querySelector(".product-quantity[data-product-id='" + productId + "']").textContent = newQuantity;
            })
            .catch((error) => {
                console.error("Error:", error);
            });
    }
</script>
</body>
</html>
